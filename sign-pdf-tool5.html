<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign PDF Online - Free Digital Signature Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --success: #4cc9f0;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7ff;
            color: var(--dark);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .tool-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 3rem 0;
        }

        .upload-section, .signature-options, .preview-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.03);
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .signature-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1.5rem;
        }

        .signature-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .signature-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .signature-content {
            display: none;
        }

        .signature-content.active {
            display: block;
        }

        #signatureCanvas {
            width: 100%;
            height: 200px;
            cursor: crosshair;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
        }

        .canvas-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #3ab3d9;
        }

        .btn-disabled {
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
        }

        .preview-container {
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            height: 500px;
            overflow: auto;
            position: relative;
            background: #f8f9fa;
        }

        .signature-placeholder {
            position: absolute;
            border: 2px dashed var(--accent);
            background: rgba(247, 37, 133, 0.1);
            cursor: move;
            display: none;
            min-width: 100px;
            min-height: 50px;
        }

        .signature-placeholder.active {
            display: block;
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            bottom: -5px;
            right: -5px;
            cursor: nw-resize;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-buttons .btn {
            flex: 1;
            padding: 1rem;
            font-size: 1.1rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--accent);
        }

        @media (max-width: 992px) {
            .tool-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tool-container">
            <!-- Left Column - Upload & Signature Options -->
            <div class="tool-left">
                <div class="upload-section">
                    <h2>Upload PDF</h2>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-file-upload" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                        <h3>Drag & Drop your PDF here</h3>
                        <p>or click to browse files</p>
                        <p class="file-types">Supported: PDF (Max: 50MB)</p>
                        <input type="file" id="fileInput" class="file-input" accept=".pdf">
                    </div>
                    <div id="fileInfo" style="display: none;">
                        <p><strong>Selected file:</strong> <span id="fileName"></span></p>
                        <p><strong>File size:</strong> <span id="fileSize"></span></p>
                    </div>
                </div>

                <div class="signature-options">
                    <h2>Create Signature</h2>
                    <div class="signature-tabs">
                        <div class="signature-tab active" data-tab="draw">Draw</div>
                        <div class="signature-tab" data-tab="type">Type</div>
                        <div class="signature-tab" data-tab="upload">Upload</div>
                    </div>

                    <div class="signature-content active" id="drawTab">
                        <div class="draw-signature">
                            <canvas id="signatureCanvas"></canvas>
                            <div class="canvas-controls">
                                <button id="clearCanvas" class="btn" style="background: transparent; border: 2px solid var(--primary); color: var(--primary);">Clear</button>
                                <button id="saveSignature" class="btn btn-primary">Save Signature</button>
                            </div>
                        </div>
                    </div>

                    <div class="signature-content" id="typeTab">
                        <div class="type-signature">
                            <input type="text" id="typedSignature" placeholder="Type your signature here" style="width: 100%; padding: 1rem; border: 1px solid #dee2e6; border-radius: var(--border-radius); font-size: 1.2rem; margin-bottom: 1rem; font-family: 'Dancing Script', cursive;">
                            <button id="saveTypedSignature" class="btn btn-primary" style="width: 100%;">Save Signature</button>
                        </div>
                    </div>

                    <div class="signature-content" id="uploadTab">
                        <div class="upload-signature">
                            <div class="upload-area" id="signatureUploadArea">
                                <i class="fas fa-file-image" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                                <h3>Upload Signature Image</h3>
                                <p>or click to browse files</p>
                                <p class="file-types">Supported: JPG, PNG, GIF (Max: 5MB)</p>
                                <input type="file" id="signatureFileInput" class="file-input" accept=".jpg,.jpeg,.png,.gif">
                            </div>
                            <div id="signaturePreview" style="display: none; margin-top: 1rem; text-align: center;">
                                <img id="signatureImage" src="" alt="Signature Preview" style="max-width: 100%; max-height: 150px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Preview -->
            <div class="tool-right">
                <div class="preview-section">
                    <div class="preview-header">
                        <h2>Preview</h2>
                        <div class="page-controls" style="display: none;" id="pageControls">
                            <button id="prevPage" class="btn" style="background: transparent; border: 2px solid var(--primary); color: var(--primary); padding: 0.5rem 1rem;"><i class="fas fa-chevron-left"></i></button>
                            <span id="pageInfo">Page 1 of 1</span>
                            <button id="nextPage" class="btn" style="background: transparent; border: 2px solid var(--primary); color: var(--primary); padding: 0.5rem 1rem;"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="preview-container">
                        <div id="pdfPreview">
                            <div style="text-align: center; padding: 2rem;">
                                <i class="fas fa-file-pdf" style="font-size: 4rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                                <h3>PDF Preview</h3>
                                <p>Upload a PDF file to get started</p>
                            </div>
                        </div>
                        <div class="signature-placeholder" id="signaturePlaceholder">
                            <div class="resize-handle"></div>
                        </div>
                    </div>
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner"></div>
                        <p>Processing PDF...</p>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="addSignatureBtn" class="btn btn-primary" disabled>Add Signature to PDF</button>
                    <button id="downloadBtn" class="btn btn-success" disabled>Download Signed PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Global variables
        let currentPdf = null;
        let currentPage = 1;
        let totalPages = 1;
        let signatureImage = null;
        let signatureDataUrl = null;
        let pdfBytes = null;
        let pdfDoc = null;
        let pdfPages = [];
        let currentScale = 1;
        let currentViewport = null;

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const pdfPreview = document.getElementById('pdfPreview');
        const pageControls = document.getElementById('pageControls');
        const pageInfo = document.getElementById('pageInfo');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const signaturePlaceholder = document.getElementById('signaturePlaceholder');
        const addSignatureBtn = document.getElementById('addSignatureBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Signature creation elements
        const signatureTabs = document.querySelectorAll('.signature-tab');
        const signatureContents = document.querySelectorAll('.signature-content');
        const signatureCanvas = document.getElementById('signatureCanvas');
        const clearCanvas = document.getElementById('clearCanvas');
        const saveSignature = document.getElementById('saveSignature');
        const typedSignature = document.getElementById('typedSignature');
        const saveTypedSignature = document.getElementById('saveTypedSignature');
        const signatureFileInput = document.getElementById('signatureFileInput');
        const signatureUploadArea = document.getElementById('signatureUploadArea');
        const signaturePreview = document.getElementById('signaturePreview');
        const signatureImageElement = document.getElementById('signatureImage');

        // Initialize signature canvas
        const ctx = signatureCanvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Set canvas size
        signatureCanvas.width = signatureCanvas.offsetWidth;
        signatureCanvas.height = signatureCanvas.offsetHeight;

        // Canvas drawing functions
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // Event listeners for canvas
        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);

        // Clear canvas
        clearCanvas.addEventListener('click', () => {
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        });

        // Save drawn signature
        saveSignature.addEventListener('click', () => {
            if (signatureCanvas.width === 0 || signatureCanvas.height === 0) {
                showNotification('Please draw a signature first', 'error');
                return;
            }
            
            signatureDataUrl = signatureCanvas.toDataURL('image/png');
            signatureImage = new Image();
            signatureImage.src = signatureDataUrl;
            enableSignatureButtons();
            showNotification('Signature saved successfully!', 'success');
        });

        // Save typed signature
        saveTypedSignature.addEventListener('click', () => {
            if (!typedSignature.value.trim()) {
                showNotification('Please type your signature first', 'error');
                return;
            }

            // Create a canvas for the typed signature
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Set canvas size based on text
            tempCtx.font = "48px 'Dancing Script', cursive";
            const textWidth = tempCtx.measureText(typedSignature.value).width;
            
            tempCanvas.width = textWidth + 40;
            tempCanvas.height = 80;
            
            // Draw the text
            tempCtx.font = "48px 'Dancing Script', cursive";
            tempCtx.fillStyle = '#000';
            tempCtx.textBaseline = 'middle';
            tempCtx.fillText(typedSignature.value, 20, 40);
            
            signatureDataUrl = tempCanvas.toDataURL('image/png');
            signatureImage = new Image();
            signatureImage.src = signatureDataUrl;
            enableSignatureButtons();
            showNotification('Signature saved successfully!', 'success');
        });

        // Upload signature image
        signatureFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File size must be less than 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                signatureDataUrl = e.target.result;
                signatureImage = new Image();
                signatureImage.src = signatureDataUrl;
                signatureImageElement.src = signatureDataUrl;
                signaturePreview.style.display = 'block';
                enableSignatureButtons();
                showNotification('Signature uploaded successfully!', 'success');
            };
            reader.readAsDataURL(file);
        });

        // Signature tab switching
        signatureTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                signatureTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding content
                signatureContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}Tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // File upload handling
        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary)';
            uploadArea.style.backgroundColor = 'rgba(67, 97, 238, 0.05)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#dee2e6';
            uploadArea.style.backgroundColor = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#dee2e6';
            uploadArea.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e);
            }
        });

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                showNotification('Please select a PDF file', 'error');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('File size must be less than 50MB', 'error');
                return;
            }
            
            // Show file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            // Load and display PDF
            await loadPdf(file);
        }

        async function loadPdf(file) {
            loadingSpinner.style.display = 'block';
            pdfPreview.innerHTML = '';
            
            const fileReader = new FileReader();
            fileReader.onload = async function() {
                pdfBytes = new Uint8Array(this.result);
                
                try {
                    // Load PDF for preview
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    currentPdf = pdf;
                    totalPages = pdf.numPages;
                    currentPage = 1;
                    
                    loadingSpinner.style.display = 'none';
                    await renderPage(currentPage);
                    
                    // Show page controls if multiple pages
                    if (totalPages > 1) {
                        pageControls.style.display = 'flex';
                        updatePageInfo();
                    } else {
                        pageControls.style.display = 'none';
                    }
                    
                    // Load PDF for editing with pdf-lib
                    pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                    pdfPages = pdfDoc.getPages();
                    
                    // Enable add signature button if signature is ready
                    if (signatureImage) {
                        addSignatureBtn.disabled = false;
                        addSignatureBtn.classList.remove('btn-disabled');
                    }
                } catch (error) {
                    loadingSpinner.style.display = 'none';
                    console.error('Error loading PDF:', error);
                    showNotification('Error loading PDF. Please try another file.', 'error');
                }
            };
            
            fileReader.readAsArrayBuffer(file);
        }

        async function renderPage(pageNumber) {
            const page = await currentPdf.getPage(pageNumber);
            currentViewport = page.getViewport({ scale: 1.5 });
            currentScale = 1.5;
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = currentViewport.height;
            canvas.width = currentViewport.width;
            
            pdfPreview.innerHTML = '';
            pdfPreview.appendChild(canvas);
            
            const renderContext = {
                canvasContext: context,
                viewport: currentViewport
            };
            
            await page.render(renderContext).promise;
            
            // Set up signature placeholder
            setupSignaturePlaceholder(canvas);
        }

        function setupSignaturePlaceholder(canvas) {
            // Reset signature placeholder
            signaturePlaceholder.style.display = 'none';
            signaturePlaceholder.classList.remove('active');
            signaturePlaceholder.innerHTML = '';
            
            // Position placeholder at bottom right of canvas
            const placeholderWidth = 150;
            const placeholderHeight = 60;
            
            signaturePlaceholder.style.width = `${placeholderWidth}px`;
            signaturePlaceholder.style.height = `${placeholderHeight}px`;
            signaturePlaceholder.style.left = `${canvas.width - placeholderWidth - 20}px`;
            signaturePlaceholder.style.top = `${canvas.height - placeholderHeight - 20}px`;
            
            // Add resize handle
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            signaturePlaceholder.appendChild(resizeHandle);
            
            // Make placeholder draggable and resizable
            makeDraggable(signaturePlaceholder);
            makeResizable(signaturePlaceholder);
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                
                // Get the mouse cursor position at startup
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                // Calculate the new cursor position
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Set the element's new position
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function makeResizable(element) {
            const handle = element.querySelector('.resize-handle');
            
            handle.onmousedown = function(e) {
                e.preventDefault();
                
                let startX = e.clientX;
                let startY = e.clientY;
                let startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
                let startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
                
                function doDrag(e) {
                    element.style.width = (startWidth + e.clientX - startX) + 'px';
                    element.style.height = (startHeight + e.clientY - startY) + 'px';
                }
                
                function stopDrag() {
                    document.documentElement.removeEventListener('mousemove', doDrag, false);
                    document.documentElement.removeEventListener('mouseup', stopDrag, false);
                }
                
                document.documentElement.addEventListener('mousemove', doDrag, false);
                document.documentElement.addEventListener('mouseup', stopDrag, false);
            };
        }

        // Page navigation
        prevPage.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
                updatePageInfo();
            }
        });

        nextPage.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderPage(currentPage);
                updatePageInfo();
            }
        });

        function updatePageInfo() {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }

        // Add signature to PDF
        addSignatureBtn.addEventListener('click', () => {
            if (!signatureImage || !currentPdf) return;
            
            // Show signature placeholder
            signaturePlaceholder.style.display = 'block';
            signaturePlaceholder.classList.add('active');
            
            // Position signature image inside placeholder
            const img = document.createElement('img');
            img.src = signatureDataUrl;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            signaturePlaceholder.appendChild(img);
            
            // Enable download button
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('btn-disabled');
            
            showNotification('Signature added to PDF. You can drag to reposition and resize.', 'success');
        });

        // Download signed PDF
        downloadBtn.addEventListener('click', async () => {
            if (!pdfDoc || !signatureImage) return;
            
            loadingSpinner.style.display = 'block';
            
            try {
                // Get signature position and dimensions from the placeholder
                const placeholder = document.getElementById('signaturePlaceholder');
                const placeholderRect = placeholder.getBoundingClientRect();
                const previewRect = document.getElementById('pdfPreview').getBoundingClientRect();
                
                // Calculate relative position within the PDF page
                const pdfPage = pdfPages[currentPage - 1];
                const pdfPageWidth = pdfPage.getWidth();
                const pdfPageHeight = pdfPage.getHeight();
                
                // Calculate scale factors
                const scaleX = pdfPageWidth / previewRect.width;
                const scaleY = pdfPageHeight / previewRect.height;
                
                // Calculate signature position in PDF coordinates
                const x = (placeholderRect.left - previewRect.left) * scaleX;
                // PDF coordinates start from bottom left, so we need to invert Y
                const y = pdfPageHeight - (placeholderRect.top - previewRect.top) * scaleY - (placeholderRect.height * scaleY);
                const width = placeholderRect.width * scaleX;
                const height = placeholderRect.height * scaleY;
                
                console.log('Signature position:', { x, y, width, height });
                console.log('PDF page dimensions:', { width: pdfPageWidth, height: pdfPageHeight });
                
                // Convert data URL to Uint8Array
                const signatureResponse = await fetch(signatureDataUrl);
                const signatureBlob = await signatureResponse.blob();
                const signatureArrayBuffer = await signatureBlob.arrayBuffer();
                const signatureUint8Array = new Uint8Array(signatureArrayBuffer);
                
                // Embed the signature image
                let embeddedImage;
                if (signatureDataUrl.startsWith('data:image/png')) {
                    embeddedImage = await pdfDoc.embedPng(signatureUint8Array);
                } else {
                    embeddedImage = await pdfDoc.embedJpg(signatureUint8Array);
                }
                
                // Add signature to the current page
                pdfPage.drawImage(embeddedImage, {
                    x: x,
                    y: y,
                    width: width,
                    height: height,
                });
                
                // Save the PDF with the signature
                const modifiedPdfBytes = await pdfDoc.save();
                
                // Download the file
                download(modifiedPdfBytes, "signed-document.pdf", "application/pdf");
                
                loadingSpinner.style.display = 'none';
                showNotification('Signed PDF downloaded successfully!', 'success');
            } catch (error) {
                loadingSpinner.style.display = 'none';
                console.error('Error signing PDF:', error);
                showNotification('Error signing PDF: ' + error.message, 'error');
            }
        });

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function enableSignatureButtons() {
            if (currentPdf) {
                addSignatureBtn.disabled = false;
                addSignatureBtn.classList.remove('btn-disabled');
            }
        }

        function showNotification(message, type) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set up initial canvas
            signatureCanvas.width = signatureCanvas.offsetWidth;
            signatureCanvas.height = signatureCanvas.offsetHeight;
            
            // Draw initial canvas border
            ctx.strokeStyle = '#dee2e6';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        });
    </script>
</body>
</html>
